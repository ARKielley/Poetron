// var characterTable = {"0":"1","1":"2","2":"3","3":"4","4":"5","5":"6","6":"7","7":"8","8":"april","9":"is","10":"the","11":"cruellest","12":"month","13":"breeding","14":"lilacs","15":"out","16":"of","17":"dead","18":"land","19":"mixing","20":"memory","21":"and","22":"desire","23":"stirring","24":"dull","25":"roots","26":"with","27":"spring","28":"rain","29":"winter","30":"kept","31":"us","32":"warm","33":"covering","34":"earth","35":"in","36":"forgetful","37":"from","38":"fairest","39":"creatures","40":"we","41":"increase","42":"that","43":"thereby","44":"beauty","45":"s","46":"rose","47":"might","48":"never","49":"die","50":"but","51":"as","52":"riper","53":"should","54":"by","55":"time","56":"decease","57":"his","58":"tender","59":"heir","60":"bear","61":"he","62":"disappeared","63":"brooks","64":"were","65":"frozen","66":"airports","67":"almost","68":"deserted","69":"snow","70":"disfigured","71":"public","72":"statues","73":"mercury","74":"sank","75":"mouth","76":"dying","77":"had","78":"driven","79":"half","80":"night","81":"far","82":"down","83":"san","84":"joaquin","85":"through","86":"mariposa","87":"up","88":"dangerous","89":"mountain","90":"roads","91":"pulled","92":"at","93":"eight","94":"a","95":"m","96":"big","97":"truckload","98":"i","99":"saw","100":"best","101":"minds","102":"my","103":"generation","104":"destroyed","105":"madness","106":"starving","107":"hysterical","108":"naked","109":"dragging","110":"themselves","111":"negro","112":"streets","113":"dawn","114":"looking","115":"for","116":"an","117":"angry","118":"fix","119":"angelheaded","120":"hipsters","121":"burning","122":"lo","123":"man","124":"whose","125":"muse","126":"whilome","127":"did","128":"maske","129":"her","130":"taught","131":"lowly","132":"shepheards","133":"weeds","134":"am","135":"now","136":"enforst","137":"unfitter","138":"taske","139":"trumpets","140":"sterne","141":"to","142":"chaunge","143":"mine","144":"first","145":"undecoded","146":"messages","147":"read","148":"popeye","149":"sits","150":"thunder","151":"unthought","152":"shoebox","153":"apartment","154":"livid","155":"curtain’s","156":"hue","157":"tangram","158":"emerges","159":"country","160":"meanwhile","161":"there","162":"you","163":"are","164":"they","165":"aw","166":"who","167":"sent","168":"them","169":"make","170":"everything","171":"ok","172":"take","173":"your","174":"mittens","175":"what","176":"do","177":"want","178":"all","179":"healthy","180":"contact","181":"or","182":"detect","183":null,"184":null,"185":null};

// var indexTable = {"1":0,"2":1,"3":2,"4":3,"5":4,"6":5,"7":6,"8":7,"april":8,"is":9,"the":10,"cruellest":11,"month":12,"breeding":13,"lilacs":14,"out":15,"of":16,"dead":17,"land":18,"mixing":19,"memory":20,"and":21,"desire":22,"stirring":23,"dull":24,"roots":25,"with":26,"spring":27,"rain":28,"winter":29,"kept":30,"us":31,"warm":32,"covering":33,"earth":34,"in":35,"forgetful":36,"from":37,"fairest":38,"creatures":39,"we":40,"increase":41,"that":42,"thereby":43,"beauty":44,"s":45,"rose":46,"might":47,"never":48,"die":49,"but":50,"as":51,"riper":52,"should":53,"by":54,"time":55,"decease":56,"his":57,"tender":58,"heir":59,"bear":60,"he":61,"disappeared":62,"brooks":63,"were":64,"frozen":65,"airports":66,"almost":67,"deserted":68,"snow":69,"disfigured":70,"public":71,"statues":72,"mercury":73,"sank":74,"mouth":75,"dying":76,"had":77,"driven":78,"half":79,"night":80,"far":81,"down":82,"san":83,"joaquin":84,"through":85,"mariposa":86,"up":87,"dangerous":88,"mountain":89,"roads":90,"pulled":91,"at":92,"eight":93,"a":94,"m":95,"big":96,"truckload":97,"i":98,"saw":99,"best":100,"minds":101,"my":102,"generation":103,"destroyed":104,"madness":105,"starving":106,"hysterical":107,"naked":108,"dragging":109,"themselves":110,"negro":111,"streets":112,"dawn":113,"looking":114,"for":115,"an":116,"angry":117,"fix":118,"angelheaded":119,"hipsters":120,"burning":121,"lo":122,"man":123,"whose":124,"muse":125,"whilome":126,"did":127,"maske":128,"her":129,"taught":130,"lowly":131,"shepheards":132,"weeds":133,"am":134,"now":135,"enforst":136,"unfitter":137,"taske":138,"trumpets":139,"sterne":140,"to":141,"chaunge":142,"mine":143,"first":144,"undecoded":145,"messages":146,"read":147,"popeye":148,"sits":149,"thunder":150,"unthought":151,"shoebox":152,"apartment":153,"livid":154,"curtain’s":155,"hue":156,"tangram":157,"emerges":158,"country":159,"meanwhile":160,"there":161,"you":162,"are":163,"they":164,"aw":165,"who":166,"sent":167,"them":168,"make":169,"everything":170,"ok":171,"take":172,"your":173,"mittens":174,"what":175,"do":176,"want":177,"all":178,"healthy":179,"contact":180,"or":181,"detect":182,"stop-input":183,"start-output":184,"unrecognized":185};

// var characters = ["1","2","3","4","5","6","7","8","april","is","the","cruellest","month","breeding","lilacs","out","of","dead","land","mixing","memory","and","desire","stirring","dull","roots","with","spring","rain","winter","kept","us","warm","covering","earth","in","forgetful","from","fairest","creatures","we","increase","that","thereby","beauty","s","rose","might","never","die","but","as","riper","should","by","time","decease","his","tender","heir","bear","he","disappeared","brooks","were","frozen","airports","almost","deserted","snow","disfigured","public","statues","mercury","sank","mouth","dying","had","driven","half","night","far","down","san","joaquin","through","mariposa","up","dangerous","mountain","roads","pulled","at","eight","a","m","big","truckload","i","saw","best","minds","my","generation","destroyed","madness","starving","hysterical","naked","dragging","themselves","negro","streets","dawn","looking","for","an","angry","fix","angelheaded","hipsters","burning","lo","man","whose","muse","whilome","did","maske","her","taught","lowly","shepheards","weeds","am","now","enforst","unfitter","taske","trumpets","sterne","to","chaunge","mine","first","undecoded","messages","read","popeye","sits","thunder","unthought","shoebox","apartment","livid","curtain’s","hue","tangram","emerges","country","meanwhile","there","you","are","they","aw","who","sent","them","make","everything","ok","take","your","mittens","what","do","want","all","healthy","contact","or","detect","stop-input","start-output","unrecognized"];

// const json = require('./test-net-json.txt')

function netWrapper(characterTable, indexTable, characters, json) {

function toIndexesInputOutput(value1) {
  var value2 = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;
  var maxThreshold = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 0;

  var result = void 0;
  if (typeof value1 === 'string') {
    result = toIndexes(value1.split('').concat(['stop-input', 'start-output']), maxThreshold);
  } else {
    result = toIndexes(value1.concat(['stop-input', 'start-output']), maxThreshold);
  }

  if (value2 === null) return result;

  if (typeof value2 === 'string') {
    return result.concat(toIndexes(value2.split(''), maxThreshold));
  } else {
    return result.concat(toIndexes(value2, maxThreshold));
  }
}

function toIndexes(value) {
  var maxThreshold = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 0;

  var result = [];
  
  for (var i = 0, max = value.length; i < max; i++) {
    var character = value[i];
    var index = indexTable[character];
    if (index === undefined) {
      if (indexTable['unrecognized']) {
        index = indexTable['unrecognized'];
      } else {
        throw new Error('unrecognized character "' + character + '"');
      }
    }
    if (index < maxThreshold) continue;
    result.push(index);
  }

  return result;
}

function toCharacters(indices) {
  var maxThreshold = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 0;

  var result = [];
        var indexTable = indexTable;

  for (var i = 0, max = indices.length; i < max; i++) {
    var index = indices[i];
    if (index < maxThreshold) continue;
    var character = characterTable[index];
    if (character === undefined) {
      if (indexTable['unrecognized']) {
        character = characterTable[indexTable['unrecognized']];
      } else {
        throw new Error('unrecognized index "' + index + '"');
      }
    } else if (character !== null) {
      result.push(character);
    }
  }
  return result;
}

function Matrix(rows, columns) {
  this.rows = rows;
  this.columns = columns;
  this.weights = zeros(rows * columns);
}

function formatDataIn(input, output) { 
  var output = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;

  if (true !== null) {
    if (indexTable.hasOwnProperty('stop-input')) {
      return toIndexesInputOutput(input, output);
    } else {
      return toIndexes(input);
    }
  }
  return input;
}

function formatDataOut(input, output) { 
  if (true !== null) {
    return toCharacters(output).join('');
  }
  return output;
}

function zeros(size) {
  return new Float32Array(size);
}

function softmax(m) {
  var result = new Matrix(m.rows, m.columns); // probability volume
  var maxVal = -999999;
  for (var i = 0; i < m.weights.length; i++) {
    if (m.weights[i] > maxVal) {
      maxVal = m.weights[i];
    }
  }

  var s = 0;
  for (var _i = 0; _i < m.weights.length; _i++) {
    result.weights[_i] = Math.exp(m.weights[_i] - maxVal);
    s += result.weights[_i];
  }

  for (var _i2 = 0; _i2 < m.weights.length; _i2++) {
    result.weights[_i2] /= s;
  }

  // no backward pass here needed
  // since we will use the computed probabilities outside
  // to set gradients directly on m
  return result;
}

function randomF(a, b) {
  return Math.random() * (b - a) + a;
}

function sampleI(m) {
  // sample argmax from w, assuming w are
  // probabilities that sum to one
  var r = randomF(0, 1);
  var x = 0;
  var i = 0;
  var w = m.weights;

  while (true) {
    x += w[i];
    if (x > r) {
      return i;
    }
    i++;
  }
}

function maxI(m) {
  // argmax of array w
  var weights = m.weights;

  var maxv = weights[0];
  var maxix = 0;
  for (var i = 1; i < weights.length; i++) {
    var v = weights[i];
    if (v < maxv) continue;

    maxix = i;
    maxv = v;
  }
  return maxix;
}






return function runNet(rawInput, isSampleI, temperature) {

  if (typeof rawInput === 'undefined') rawInput = [];
  if (typeof isSampleI === 'undefined') isSampleI = false;
  if (typeof temperature === 'undefined') temperature = 1;
  


  
  var input = formatDataIn(rawInput);
  var maxPredictionLength = input.length + 100;
  var _i = 0;
  var output = [];
  var states = [];
  var prevStates;
  while (true) {
    var previousIndex = (_i === 0
        ? 0
        : _i < input.length
          ? input[_i - 1] + 1
          : output[_i - 1])
          ;
    var rowPluckIndex = previousIndex;
    var state;
    prevStates = states;
    states = [];
    states[0] = {
      name: 'rowPluck',
      left: json.input,
      right: null,
      product: new Matrix(186, 1)
    };
    states[1] = {
      name: 'multiply',
      left: json.hiddenLayers[0].inputMatrix,
      right: states[0].product,
      product: new Matrix(20, 1)
    };
    states[2] = {
      name: 'multiply',
      left: json.hiddenLayers[0].inputHidden,
      right: typeof prevStates[25] === 'object' ? prevStates[25].product : new Matrix(20, 1),
      product: new Matrix(20, 1)
    };
    states[3] = {
      name: 'add',
      left: states[1].product,
      right: states[2].product,
      product: new Matrix(20, 1)
    };
    states[4] = {
      name: 'add',
      left: states[3].product,
      right: json.hiddenLayers[0].inputBias,
      product: new Matrix(20, 1)
    };
    states[5] = {
      name: 'sigmoid',
      left: states[4].product,
      right: null,
      product: new Matrix(20, 1)
    };
    states[6] = {
      name: 'multiply',
      left: json.hiddenLayers[0].forgetMatrix,
      right: states[0].product,
      product: new Matrix(20, 1)
    };
    states[7] = {
      name: 'multiply',
      left: json.hiddenLayers[0].forgetHidden,
      right: states[2].right,
      product: new Matrix(20, 1)
    };
    states[8] = {
      name: 'add',
      left: states[6].product,
      right: states[7].product,
      product: new Matrix(20, 1)
    };
    states[9] = {
      name: 'add',
      left: states[8].product,
      right: json.hiddenLayers[0].forgetBias,
      product: new Matrix(20, 1)
    };
    states[10] = {
      name: 'sigmoid',
      left: states[9].product,
      right: null,
      product: new Matrix(20, 1)
    };
    states[11] = {
      name: 'multiply',
      left: json.hiddenLayers[0].outputMatrix,
      right: states[0].product,
      product: new Matrix(20, 1)
    };
    states[12] = {
      name: 'multiply',
      left: json.hiddenLayers[0].outputHidden,
      right: states[2].right,
      product: new Matrix(20, 1)
    };
    states[13] = {
      name: 'add',
      left: states[11].product,
      right: states[12].product,
      product: new Matrix(20, 1)
    };
    states[14] = {
      name: 'add',
      left: states[13].product,
      right: json.hiddenLayers[0].outputBias,
      product: new Matrix(20, 1)
    };
    states[15] = {
      name: 'sigmoid',
      left: states[14].product,
      right: null,
      product: new Matrix(20, 1)
    };
    states[16] = {
      name: 'multiply',
      left: json.hiddenLayers[0].cellActivationMatrix,
      right: states[0].product,
      product: new Matrix(20, 1)
    };
    states[17] = {
      name: 'multiply',
      left: json.hiddenLayers[0].cellActivationHidden,
      right: states[2].right,
      product: new Matrix(20, 1)
    };
    states[18] = {
      name: 'add',
      left: states[16].product,
      right: states[17].product,
      product: new Matrix(20, 1)
    };
    states[19] = {
      name: 'add',
      left: states[18].product,
      right: json.hiddenLayers[0].cellActivationBias,
      product: new Matrix(20, 1)
    };
    states[20] = {
      name: 'tanh',
      left: states[19].product,
      right: null,
      product: new Matrix(20, 1)
    };
    states[21] = {
      name: 'multiplyElement',
      left: states[10].product,
      right: states[2].right,
      product: new Matrix(20, 1)
    };
    states[22] = {
      name: 'multiplyElement',
      left: states[5].product,
      right: states[20].product,
      product: new Matrix(20, 1)
    };
    states[23] = {
      name: 'add',
      left: states[21].product,
      right: states[22].product,
      product: new Matrix(20, 1)
    };
    states[24] = {
      name: 'tanh',
      left: states[23].product,
      right: null,
      product: new Matrix(20, 1)
    };
    states[25] = {
      name: 'multiplyElement',
      left: states[15].product,
      right: states[24].product,
      product: new Matrix(20, 1)
    };
    states[26] = {
      name: 'multiply',
      left: json.hiddenLayers[1].inputMatrix,
      right: states[25].product,
      product: new Matrix(20, 1)
    };
    states[27] = {
      name: 'multiply',
      left: json.hiddenLayers[1].inputHidden,
      right: typeof prevStates[50] === 'object' ? prevStates[50].product : new Matrix(20, 1),
      product: new Matrix(20, 1)
    };
    states[28] = {
      name: 'add',
      left: states[26].product,
      right: states[27].product,
      product: new Matrix(20, 1)
    };
    states[29] = {
      name: 'add',
      left: states[28].product,
      right: json.hiddenLayers[1].inputBias,
      product: new Matrix(20, 1)
    };
    states[30] = {
      name: 'sigmoid',
      left: states[29].product,
      right: null,
      product: new Matrix(20, 1)
    };
    states[31] = {
      name: 'multiply',
      left: json.hiddenLayers[1].forgetMatrix,
      right: states[25].product,
      product: new Matrix(20, 1)
    };
    states[32] = {
      name: 'multiply',
      left: json.hiddenLayers[1].forgetHidden,
      right: states[27].right,
      product: new Matrix(20, 1)
    };
    states[33] = {
      name: 'add',
      left: states[31].product,
      right: states[32].product,
      product: new Matrix(20, 1)
    };
    states[34] = {
      name: 'add',
      left: states[33].product,
      right: json.hiddenLayers[1].forgetBias,
      product: new Matrix(20, 1)
    };
    states[35] = {
      name: 'sigmoid',
      left: states[34].product,
      right: null,
      product: new Matrix(20, 1)
    };
    states[36] = {
      name: 'multiply',
      left: json.hiddenLayers[1].outputMatrix,
      right: states[25].product,
      product: new Matrix(20, 1)
    };
    states[37] = {
      name: 'multiply',
      left: json.hiddenLayers[1].outputHidden,
      right: states[27].right,
      product: new Matrix(20, 1)
    };
    states[38] = {
      name: 'add',
      left: states[36].product,
      right: states[37].product,
      product: new Matrix(20, 1)
    };
    states[39] = {
      name: 'add',
      left: states[38].product,
      right: json.hiddenLayers[1].outputBias,
      product: new Matrix(20, 1)
    };
    states[40] = {
      name: 'sigmoid',
      left: states[39].product,
      right: null,
      product: new Matrix(20, 1)
    };
    states[41] = {
      name: 'multiply',
      left: json.hiddenLayers[1].cellActivationMatrix,
      right: states[25].product,
      product: new Matrix(20, 1)
    };
    states[42] = {
      name: 'multiply',
      left: json.hiddenLayers[1].cellActivationHidden,
      right: states[27].right,
      product: new Matrix(20, 1)
    };
    states[43] = {
      name: 'add',
      left: states[41].product,
      right: states[42].product,
      product: new Matrix(20, 1)
    };
    states[44] = {
      name: 'add',
      left: states[43].product,
      right: json.hiddenLayers[1].cellActivationBias,
      product: new Matrix(20, 1)
    };
    states[45] = {
      name: 'tanh',
      left: states[44].product,
      right: null,
      product: new Matrix(20, 1)
    };
    states[46] = {
      name: 'multiplyElement',
      left: states[35].product,
      right: states[27].right,
      product: new Matrix(20, 1)
    };
    states[47] = {
      name: 'multiplyElement',
      left: states[30].product,
      right: states[45].product,
      product: new Matrix(20, 1)
    };
    states[48] = {
      name: 'add',
      left: states[46].product,
      right: states[47].product,
      product: new Matrix(20, 1)
    };
    states[49] = {
      name: 'tanh',
      left: states[48].product,
      right: null,
      product: new Matrix(20, 1)
    };
    states[50] = {
      name: 'multiplyElement',
      left: states[40].product,
      right: states[49].product,
      product: new Matrix(20, 1)
    };
    states[51] = {
      name: 'multiply',
      left: json.outputConnector,
      right: states[50].product,
      product: new Matrix(187, 1)
    };
    states[52] = {
      name: 'add',
      left: states[51].product,
      right: json.output,
      product: new Matrix(187, 1)
    };
    for (var stateIndex = 0, stateMax = 53; stateIndex < stateMax; stateIndex++) {
      state = states[stateIndex];
      var product = state.product;
      var left = state.left;
      var right = state.right;
      
      switch (state.name) {
        case 'rowPluck': //compiled from src/recurrent/matrix/row-pluck.js
          
          var columns = left.columns;
          var rowBase = columns * rowPluckIndex;
          for (var column = 0; column < columns; column++) {
            product.weights[column] = left.weights[rowBase + column];
            
          }
        
          break;
        case 'multiply': //compiled from src/recurrent/matrix/multiply.js
          
          var leftRows = left.rows;
          var leftColumns = left.columns;
          var rightColumns = right.columns;
        
          // loop over rows of left
          for (var leftRow = 0; leftRow < leftRows; leftRow++) {
            var leftRowBase = leftColumns * leftRow;
            var rightRowBase = rightColumns * leftRow;
            // loop over cols of right
            for (var rightColumn = 0; rightColumn < rightColumns; rightColumn++) {
        
              // dot product loop
              var dot = 0;
              //loop over columns of left
              for (var leftColumn = 0; leftColumn < leftColumns; leftColumn++) {
                var rightColumnBase = rightColumns * leftColumn;
                var leftIndex = leftRowBase + leftColumn;
                var rightIndex = rightColumnBase + rightColumn;
                dot += left.weights[leftIndex] * right.weights[rightIndex];
                
                
              }
              product.weights[rightRowBase + rightColumn] = dot;
            }
          }
        
          break;
        case 'add': //compiled from src/recurrent/matrix/add.js
          
          for (var i = 0; i < left.weights.length; i++) {
            product.weights[i] = left.weights[i] + right.weights[i];
            
          }
        
          break;
        case 'sigmoid': //compiled from src/recurrent/matrix/sigmoid.js
          
          // sigmoid nonlinearity
          for (var i = 0; i < left.weights.length; i++) {
            product.weights[i] = 1 / (1 + Math.exp(-left.weights[i]));
            
          }
        
          break;
        case 'tanh': //compiled from src/recurrent/matrix/tanh.js
          
          // tanh nonlinearity
          for (var i = 0; i < left.weights.length; i++) {
            product.weights[i] = Math.tanh(left.weights[i]);
            
          }
        
          break;
        case 'multiplyElement': //compiled from src/recurrent/matrix/multiply-element.js
          
          var weights = left.weights;
        
          for (var i = 0; i < weights.length; i++) {
            product.weights[i] = left.weights[i] * right.weights[i];
            
          }
        
          break;
      }
    }
    
    var logProbabilities = state.product;
    if (temperature !== 1 && isSampleI) {
      for (var q = 0, nq = logProbabilities.weights.length; q < nq; q++) {
        logProbabilities.weights[q] /= temperature;
      }
    }

    var probs = softmax(logProbabilities);
    var nextIndex = isSampleI ? sampleI(probs) : maxI(probs);
    
    _i++;
    if (nextIndex === 0) {
      break;
    }
    if (_i >= maxPredictionLength) {
      break;
    }

    output.push(nextIndex);
  }
  return formatDataOut(input, output.slice(input.length).map(function(value) { return value - 1; }));
}
return runNet()
}

module.exports = netWrapper